// server/routes/oauth.js - Version compl√®te avec JWT_SECRET corrig√©
const express = require('express');
const router = express.Router();
const jwt = require('jsonwebtoken');
const axios = require('axios');
const User = require('../models/User');
const azureConfig = require('../config/azureConfig');

const JWT_SECRET = process.env.JWT_SECRET || 'votre_cl√©_secr√®te_par_d√©faut';

// Fonction pour mapper les d√©partements Microsoft vers nos services
const mapDepartmentToService = (department) => {
  if (!department) return 'general';
  
  const deptLower = department.toLowerCase();
  
  // Mapping fran√ßais
  if (deptLower.includes('rh') || deptLower.includes('ressources humaines') || 
      deptLower.includes('human resources') || deptLower.includes('hr')) {
    return 'rh';
  }
  if (deptLower.includes('marketing') || deptLower.includes('communication') || 
      deptLower.includes('comm')) {
    return 'marketing';
  }
  if (deptLower.includes('informatique') || deptLower.includes('it') || 
      deptLower.includes('information technology') || deptLower.includes('tech')) {
    return 'informatique';
  }
  if (deptLower.includes('commercial') || deptLower.includes('vente') || 
      deptLower.includes('sales') || deptLower.includes('commerce')) {
    return 'commerce';
  }
  if (deptLower.includes('achat') || deptLower.includes('procurement') || 
      deptLower.includes('purchasing')) {
    return 'achat';
  }
  if (deptLower.includes('comptabilit√©') || deptLower.includes('finance') || 
      deptLower.includes('accounting') || deptLower.includes('compta')) {
    return 'comptabilit√©';
  }
  if (deptLower.includes('logistique') || deptLower.includes('supply chain') || 
      deptLower.includes('logistics')) {
    return 'logistique';
  }
  
  return 'general'; // Service par d√©faut
};

// Route de test pour v√©rifier la configuration
router.get('/test-config', (req, res) => {
  const config = {
    hasClientId: !!process.env.AZURE_CLIENT_ID,
    hasClientSecret: !!process.env.AZURE_CLIENT_SECRET,
    hasTenantId: !!process.env.AZURE_TENANT_ID,
    redirectUri: azureConfig.redirectUri,
    authority: azureConfig.authority,
    clientIdLength: process.env.AZURE_CLIENT_ID?.length || 0,
    tenantIdLength: process.env.AZURE_TENANT_ID?.length || 0
  };
  
  res.json({
    message: 'Configuration OAuth',
    config: config,
    note: 'V√©rifiez que toutes les valeurs sont pr√©sentes'
  });
});

// Route pour obtenir l'URL d'autorisation (sans MSAL)
router.get('/auth-url', async (req, res) => {
  try {
    console.log('üîç G√©n√©ration URL d\'autorisation manuelle...');
    console.log('üîç Redirect URI utilis√©:', azureConfig.redirectUri);
    console.log('üîç Scopes demand√©s:', azureConfig.scopes);
    
    // Construire l'URL d'autorisation manuellement
    const baseUrl = `https://login.microsoftonline.com/${azureConfig.tenantId}/oauth2/v2.0/authorize`;
    const params = new URLSearchParams({
      client_id: azureConfig.clientId,
      response_type: 'code',
      redirect_uri: azureConfig.redirectUri,
      scope: azureConfig.scopes.join(' '),
      response_mode: 'query',
      state: Math.random().toString(36).substring(2, 15) // √âtat al√©atoire pour la s√©curit√©
    });
    
    const authUrl = `${baseUrl}?${params.toString()}`;
    console.log('üîç URL g√©n√©r√©e manuellement:', authUrl);
    
    res.json({ authUrl });
  } catch (error) {
    console.error('‚ùå Erreur lors de la g√©n√©ration de l\'URL d\'auth:', error);
    res.status(500).json({ 
      message: 'Erreur lors de la g√©n√©ration de l\'URL d\'authentification',
      error: error.message
    });
  }
});

// Route de callback pour traiter le code d'autorisation (sans MSAL)
router.post('/callback', async (req, res) => {
  try {
    console.log('üîç Callback OAuth re√ßu (impl√©mentation manuelle)...');
    const { code, state } = req.body;
    console.log('üîç Code:', code ? 'Pr√©sent' : 'Absent');
    console.log('üîç State:', state);

    if (!code) {
      console.error('‚ùå Code d\'autorisation manquant');
      return res.status(400).json({ message: 'Code d\'autorisation manquant' });
    }

    // √âchanger le code contre un token avec une requ√™te HTTP manuelle
    console.log('üîç √âchange du code contre un token (requ√™te manuelle)...');
    
    const tokenEndpoint = `https://login.microsoftonline.com/${azureConfig.tenantId}/oauth2/v2.0/token`;
    
    const tokenRequestBody = new URLSearchParams({
      client_id: azureConfig.clientId,
      client_secret: azureConfig.clientSecret,
      code: code,
      redirect_uri: azureConfig.redirectUri,
      grant_type: 'authorization_code',
      scope: azureConfig.scopes.join(' ')
    });

    console.log('üîç Endpoint de token:', tokenEndpoint);
    console.log('üîç Param√®tres de la requ√™te:', {
      client_id: azureConfig.clientId,
      has_client_secret: !!azureConfig.clientSecret,
      redirect_uri: azureConfig.redirectUri,
      grant_type: 'authorization_code',
      scope: azureConfig.scopes.join(' ')
    });

    // Faire la requ√™te avec axios (d√©sactiver SSL pour le d√©veloppement)
    const tokenResponse = await axios.post(tokenEndpoint, tokenRequestBody, {
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Accept': 'application/json'
      },
      timeout: 10000, // Timeout de 10 secondes
      httpsAgent: new (require('https').Agent)({
        rejectUnauthorized: false // SEULEMENT pour le d√©veloppement !
      })
    });

    console.log('üîç Token obtenu avec succ√®s:', {
      status: tokenResponse.status,
      hasAccessToken: !!tokenResponse.data.access_token,
      hasIdToken: !!tokenResponse.data.id_token
    });

    const { access_token, id_token } = tokenResponse.data;

    if (!access_token) {
      throw new Error('Token d\'acc√®s non re√ßu');
    }

    // D√©coder le ID token pour obtenir les informations utilisateur
    console.log('üîç D√©codage du ID token...');
    const idTokenPayload = JSON.parse(Buffer.from(id_token.split('.')[1], 'base64').toString());
    
    console.log('üîç Informations utilisateur du ID token:', {
      email: idTokenPayload.email || idTokenPayload.preferred_username,
      name: idTokenPayload.name,
      given_name: idTokenPayload.given_name,
      family_name: idTokenPayload.family_name
    });

    const userEmail = idTokenPayload.email || idTokenPayload.preferred_username;
    const userName = idTokenPayload.name || '';
    const firstName = idTokenPayload.given_name || userName.split(' ')[0] || '';
    const lastName = idTokenPayload.family_name || userName.split(' ').slice(1).join(' ') || '';

    if (!userEmail) {
      throw new Error('Email utilisateur non trouv√© dans le token');
    }

    // R√©cup√©rer les informations d√©taill√©es depuis Microsoft Graph
    console.log('üîç R√©cup√©ration des informations Microsoft Graph...');
    let jobTitle = 'Employ√©'; // Valeur par d√©faut
    let department = 'general'; // Valeur par d√©faut
    let profilePhotoUrl = null; // Photo de profil

    try {
      // Essayer d'abord l'endpoint /me pour les informations de base
      const graphResponse = await axios.get('https://graph.microsoft.com/v1.0/me', {
        headers: {
          'Authorization': `Bearer ${access_token}`,
          'Accept': 'application/json'
        },
        httpsAgent: new (require('https').Agent)({
          rejectUnauthorized: false
        }),
        timeout: 5000
      });

      console.log('üîç Donn√©es Microsoft Graph re√ßues:', {
        jobTitle: graphResponse.data.jobTitle,
        department: graphResponse.data.department,
        companyName: graphResponse.data.companyName,
        officeLocation: graphResponse.data.officeLocation
      });

      // R√©cup√©rer la photo de profil
      try {
        console.log('üîç R√©cup√©ration de la photo de profil...');
        const photoResponse = await axios.get('https://graph.microsoft.com/v1.0/me/photo/$value', {
          headers: {
            'Authorization': `Bearer ${access_token}`,
          },
          responseType: 'arraybuffer', // Important pour les images
          httpsAgent: new (require('https').Agent)({
            rejectUnauthorized: false
          }),
          timeout: 5000
        });

        if (photoResponse.data && photoResponse.data.byteLength > 0) {
          // Convertir l'image en base64
          const base64Image = Buffer.from(photoResponse.data).toString('base64');
          const mimeType = photoResponse.headers['content-type'] || 'image/jpeg';
          profilePhotoUrl = `data:${mimeType};base64,${base64Image}`;
          console.log('‚úÖ Photo de profil r√©cup√©r√©e avec succ√®s');
        }
      } catch (photoError) {
        console.warn('‚ö†Ô∏è Impossible de r√©cup√©rer la photo de profil:', photoError.message);
        // Continuer sans photo
      }

      // Si pas de d√©partement dans /me, essayer avec l'endpoint √©tendu
      if (!graphResponse.data.department) {
        console.log('üîç Tentative de r√©cup√©ration √©tendue des informations...');
        
        try {
          const extendedResponse = await axios.get('https://graph.microsoft.com/v1.0/me?$select=department,jobTitle,companyName,officeLocation,employeeId,mail', {
            headers: {
              'Authorization': `Bearer ${access_token}`,
              'Accept': 'application/json'
            },
            httpsAgent: new (require('https').Agent)({
              rejectUnauthorized: false
            }),
            timeout: 5000
          });

          console.log('üîç Donn√©es √©tendues Microsoft Graph:', extendedResponse.data);
          
          if (extendedResponse.data.department) {
            graphResponse.data.department = extendedResponse.data.department;
          }
        } catch (extError) {
          console.warn('‚ö†Ô∏è Impossible de r√©cup√©rer les informations √©tendues:', extError.message);
        }
      }

      // Utiliser les vraies informations de poste et d√©partement
      if (graphResponse.data.jobTitle) {
        jobTitle = graphResponse.data.jobTitle;
      }
      
      if (graphResponse.data.department) {
        // Mapper le d√©partement Microsoft vers nos services
        department = mapDepartmentToService(graphResponse.data.department);
      } else if (graphResponse.data.officeLocation) {
        // Si pas de d√©partement, essayer d'utiliser l'officeLocation
        console.log('üîç Utilisation de officeLocation comme fallback:', graphResponse.data.officeLocation);
        department = mapDepartmentToService(graphResponse.data.officeLocation);
      }

    } catch (graphError) {
      console.warn('‚ö†Ô∏è Impossible de r√©cup√©rer les informations Graph, utilisation des valeurs par d√©faut:', graphError.message);
      // On continue avec les valeurs par d√©faut
    }

    // V√©rifier si l'utilisateur existe d√©j√†
    console.log('üîç Recherche utilisateur existant...');
    let user = await User.findOne({ email: userEmail });

    if (!user) {
      console.log('üîç Cr√©ation nouvel utilisateur OAuth...');
      try {
        user = new User({
          firstName: firstName,
          lastName: lastName,
          email: userEmail,
          role: jobTitle, // Utilise le vrai poste depuis Microsoft Graph
          service: department, // Utilise le vrai service depuis Microsoft Graph
          avatar: profilePhotoUrl, // Photo de profil Microsoft
          isOAuthUser: true
        });

        await user.save();
        console.log('‚úÖ Nouvel utilisateur OAuth cr√©√©:', user.email);
      } catch (error) {
        if (error.code === 11000) {
          // L'utilisateur a √©t√© cr√©√© entre-temps par une autre requ√™te
          console.log('üîç Utilisateur cr√©√© simultan√©ment, r√©cup√©ration...');
          user = await User.findOne({ email: userEmail });
        } else {
          throw error;
        }
      }
    } else {
      // Mettre √† jour la derni√®re connexion et les informations depuis Microsoft Graph
      user.lastLogin = new Date();
      user.isOAuthUser = true;
      
      // Mettre √† jour le poste et le service si disponibles depuis Microsoft Graph
      if (jobTitle && jobTitle !== 'Employ√©') {
        user.role = jobTitle;
      }
      if (department && department !== 'general') {
        user.service = department;
      }
      // Mettre √† jour la photo de profil si disponible
      if (profilePhotoUrl) {
        user.avatar = profilePhotoUrl;
      }
      
      await user.save();
      console.log('‚úÖ Utilisateur OAuth existant connect√© et mis √† jour:', user.email);
      console.log('‚úÖ Poste:', user.role);
      console.log('‚úÖ Service:', user.service);
      console.log('‚úÖ Photo de profil:', profilePhotoUrl ? 'Mise √† jour' : 'Non disponible');
    }

    // Cr√©er le payload JWT
    const payload = {
      user: {
        id: user.id,
        firstName: user.firstName,
        lastName: user.lastName,
        role: user.role,
        service: user.service,
        isAdmin: user.isAdmin
      }
    };

    // G√©n√©rer le token JWT
    const token = jwt.sign(payload, JWT_SECRET, { expiresIn: '24h' });
    console.log('‚úÖ Token JWT g√©n√©r√©');

    res.json({
      token,
      user: {
        id: user.id,
        firstName: user.firstName,
        lastName: user.lastName,
        email: user.email,
        role: user.role,
        service: user.service,
        avatar: user.avatar, // Inclure l'avatar dans la r√©ponse
        isAdmin: user.isAdmin,
        isOAuthUser: user.isOAuthUser
      }
    });

  } catch (error) {
    console.error('‚ùå Erreur lors du callback OAuth:', error);
    console.error('‚ùå Message:', error.message);
    
    // D√©tails sp√©cifiques aux erreurs axios
    if (error.response) {
      console.error('‚ùå Statut HTTP:', error.response.status);
      console.error('‚ùå Donn√©es de r√©ponse:', error.response.data);
    }
    
    res.status(500).json({ 
      message: 'Erreur lors de l\'authentification OAuth',
      error: error.message,
      details: error.response?.data || 'Aucun d√©tail disponible'
    });
  }
});

// Route de test de connectivit√© r√©seau
router.get('/test-network', async (req, res) => {
  try {
    const tokenEndpoint = `https://login.microsoftonline.com/${azureConfig.tenantId}/oauth2/v2.0/token`;
    
    console.log('üîç Test de connectivit√© vers:', tokenEndpoint);
    
    // Test simple de connectivit√© avec axios
    const testResponse = await axios.post(tokenEndpoint, 'grant_type=client_credentials', {
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      timeout: 5000,
      validateStatus: () => true // Accepter tous les codes de statut pour le test
    });
    
    console.log('üîç R√©ponse du test:', testResponse.status);
    
    res.json({
      message: 'Test de connectivit√© r√©seau',
      tokenEndpoint: tokenEndpoint,
      httpStatus: testResponse.status,
      reachable: testResponse.status !== undefined,
      canConnect: testResponse.status < 500
    });
    
  } catch (error) {
    console.error('‚ùå Erreur de connectivit√©:', error.message);
    res.status(500).json({
      message: 'Erreur de connectivit√© r√©seau',
      error: error.message,
      suggestion: 'V√©rifiez votre connexion internet et les param√®tres de proxy'
    });
  }
});

module.exports = router;